<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sector Vulnerability Assessments (Group 3) - Expert Response Distribution</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Figtree:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Figtree', Arial, sans-serif;
            margin: 0;
            padding: 5px;
            background-color: transparent;
        }
        
        .matrix-container {
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 0;
            max-width: 650px;
            margin: 0;
        }
        
        .sample-size {
            text-align: center;
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 15px;
        }
        
        .matrix-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 5px;
            table-layout: fixed;
        }
        
        .matrix-table th {
            background-color: transparent;
            padding: 6px 4px;
            text-align: center;
            font-weight: bold;
            border: none;
            font-size: 14px;
        }
        
        .sector-label {
            background-color: transparent;
            padding: 8px 6px;
            font-weight: bold;
            text-align: left;
            border: none;
            border-top: 1px solid #666;
            width: 140px;
            font-size: 15px;
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.3;
            hyphens: auto;
        }
        
        .response-cell {
            padding: 5px 4px;
            text-align: center;
            border: none;
            border-top: 1px solid #666;
            position: relative;
            min-width: 80px;
            background-color: transparent;
            vertical-align: bottom;
        }
        
        .bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }
        
        .distribution-bar {
            width: 50px;
            border-radius: 3px 3px 0 0;
            transition: height 0.4s ease;
            min-height: 3px;
            position: relative;
            margin-bottom: 4px;
            border: 1px solid #666;
        }
        
        .bar-label {
            text-align: center;
            font-size: 11px;
            font-weight: bold;
            color: #333;
            line-height: 1.1;
            padding: 2px 4px;
        }
        
        .participant-count {
            font-size: 10px;
            color: #666;
            margin-top: 1px;
        }
        
        .median-indicator {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            color: #ea4335;
            z-index: 10;
        }
        
        .legend {
            margin-top: 15px;
            padding: 0;
            background-color: transparent;
            border-radius: 0;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: #5f6368;
        }
        
        .legend-arrow {
            font-size: 14px;
            color: #ea4335;
        }
        
        .legend-bar {
            width: 20px;
            height: 16px;
            background-color: #1a73e8;
            border-radius: 3px;
            box-shadow: 0 2px 4px rgba(26, 115, 232, 0.3);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #c41e3a;
            background-color: #f8d7da;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .qualitative-dropdown {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #f9f9f9;
        }
        
        .dropdown-header {
            padding: 12px 15px;
            background-color: #e8f4f8;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #2c5aa0;
            transition: background-color 0.2s ease;
        }
        
        .dropdown-header:hover {
            background-color: #d4e7f0;
        }
        
        .dropdown-arrow {
            font-size: 12px;
            transition: transform 0.3s ease;
        }
        
        .dropdown-arrow.expanded {
            transform: rotate(180deg);
        }
        
        .dropdown-content {
            display: none;
            padding: 15px;
            background-color: white;
            border-radius: 0 0 6px 6px;
        }
        
        .dropdown-content.show {
            display: block;
        }
        
        .justification-section {
            margin-bottom: 15px;
        }
        
        .justification-title {
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .justification-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .justification-list li {
            margin-bottom: 4px;
            line-height: 1.4;
            color: #555;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div style="display: inline-block; border: 2px solid #4caf50; border-radius: 4px; padding: 5px; margin: 5px 0;">
        <div style="background-color: #4caf50; color: white; padding: 4px 8px; margin: -5px -5px 5px -5px; border-radius: 2px 2px 0 0; font-weight: bold; font-size: 14px; text-align: right;">
            ‚ö†Ô∏è Aggregated R1 Expert Judgements - Please Review Before Submitting Revised Assessments
        </div>
        <div class="matrix-container">
            <div id="loadingMessage" class="loading">Loading sector vulnerability data...</div>
            <div id="errorMessage" class="error" style="display: none;">Risk data not found. Please check the URL parameter.</div>
        
        <div id="mainContent" style="display: none;">
            <table class="matrix-table">
                <thead>
                    <tr>
                        <th style="width: 140px;"></th>
                        <th>Not at all vulnerable</th>
                        <th>Minimally vulnerable</th>
                        <th>Moderately vulnerable</th>
                        <th>Highly vulnerable</th>
                        <th>Extremely vulnerable</th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-sector="educational_services">
                        <td class="sector-label">
                            Educational Services
                        </td>
                        <td class="response-cell" data-response="not_at_all"></td>
                        <td class="response-cell" data-response="minimally"></td>
                        <td class="response-cell" data-response="moderately"></td>
                        <td class="response-cell" data-response="highly"></td>
                        <td class="response-cell" data-response="extremely"></td>
                    </tr>
                    <tr data-sector="health_care">
                        <td class="sector-label">
                            Health Care and Social Assistance
                        </td>
                        <td class="response-cell" data-response="not_at_all"></td>
                        <td class="response-cell" data-response="minimally"></td>
                        <td class="response-cell" data-response="moderately"></td>
                        <td class="response-cell" data-response="highly"></td>
                        <td class="response-cell" data-response="extremely"></td>
                    </tr>
                    <tr data-sector="arts_entertainment">
                        <td class="sector-label">
                            Arts, Entertainment, and Recreation
                        </td>
                        <td class="response-cell" data-response="not_at_all"></td>
                        <td class="response-cell" data-response="minimally"></td>
                        <td class="response-cell" data-response="moderately"></td>
                        <td class="response-cell" data-response="highly"></td>
                        <td class="response-cell" data-response="extremely"></td>
                    </tr>
                    <tr data-sector="accommodation_food">
                        <td class="sector-label">
                            Accommodation, Food, and Other Services
                        </td>
                        <td class="response-cell" data-response="not_at_all"></td>
                        <td class="response-cell" data-response="minimally"></td>
                        <td class="response-cell" data-response="moderately"></td>
                        <td class="response-cell" data-response="highly"></td>
                        <td class="response-cell" data-response="extremely"></td>
                    </tr>
                </tbody>
            </table>
            
            <div class="legend">
                <div class="legend-item">
                    <span class="legend-arrow">‚ñº</span>
                    <span>Median vulnerability level (50th percentile)</span>
                </div>
            </div>
            
            <div class="qualitative-dropdown" id="qualitativeDropdown">
                <div class="dropdown-header" onclick="toggleDropdown()">
                    <span>üìù Expert Qualitative Justifications</span>
                    <span class="dropdown-arrow" id="dropdownArrow">‚ñº</span>
                </div>
                <div class="dropdown-content" id="dropdownContent">
                    <div id="justificationContent">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        // Risk definitions
        const riskTitles = {
            '1.1': 'Unfair discrimination and misrepresentation',
            '1.2': 'Privacy violations and unauthorized surveillance',
            '1.3': 'Lack of transparency and explainability',
            '2.1': 'Manipulation and deception',
            '2.2': 'Misinformation and disinformation',
            '2.3': 'Harmful content generation'
        };
        
        // Sample sector vulnerability data
        const sectorDataStore = {
            '1.1': {
                data: {
                    educational_services: { not_at_all: 7, minimally: 9, moderately: 6, highly: 2, extremely: 1 },
                    health_care: { not_at_all: 3, minimally: 6, moderately: 8, highly: 6, extremely: 2 },
                    arts_entertainment: { not_at_all: 5, minimally: 8, moderately: 7, highly: 4, extremely: 1 },
                    accommodation_food: { not_at_all: 9, minimally: 8, moderately: 5, highly: 2, extremely: 1 }
                },
                totalExperts: 25
            },
            '1.2': {
                data: {
                    educational_services: { not_at_all: 4, minimally: 7, moderately: 8, highly: 5, extremely: 1 },
                    health_care: { not_at_all: 1, minimally: 3, moderately: 6, highly: 9, extremely: 6 },
                    arts_entertainment: { not_at_all: 6, minimally: 8, moderately: 6, highly: 4, extremely: 1 },
                    accommodation_food: { not_at_all: 8, minimally: 9, moderately: 5, highly: 2, extremely: 1 }
                },
                totalExperts: 25
            }
        };
        
        // Qualitative justifications from experts for sector assessments (group 3)
        const qualitativeJustifications = {
            '1.1': {
                high_vulnerability: [
                    "Health care sector uses AI for critical decisions including diagnosis, treatment recommendations, and patient triage",
                    "Educational services employ AI for student assessment, admissions, and academic tracking with long-term impacts",
                    "AI-driven algorithms in healthcare can perpetuate racial and socioeconomic disparities in medical care",
                    "Educational AI systems may reinforce existing educational inequities and limit student opportunities",
                    "Arts and entertainment use AI for content recommendation and creator compensation, affecting cultural representation"
                ],
                moderate_vulnerability: [
                    "Some healthcare institutions have clinical oversight processes that can catch discriminatory patterns",
                    "Educational institutions increasingly adopt AI ethics guidelines and bias detection tools",
                    "Regulatory frameworks like FERPA provide some protection in educational contexts",
                    "Entertainment industry has some diversity and inclusion initiatives that address AI bias"
                ],
                low_vulnerability: [
                    "Accommodation and food services have more limited AI applications with less direct personal impact",
                    "Healthcare has established patient rights and medical ethics frameworks",
                    "Educational institutions subject to civil rights oversight and anti-discrimination laws"
                ]
            },
            '1.2': {
                high_vulnerability: [
                    "Health care sector collects and processes extremely sensitive personal health information through AI systems",
                    "Educational services maintain comprehensive student records and behavioral data for AI-driven analytics",
                    "Healthcare AI systems often require access to detailed personal and family medical histories",
                    "Educational AI tracks detailed student performance, social interactions, and personal development data",
                    "Cross-institutional data sharing in healthcare and education creates complex privacy exposure points"
                ],
                moderate_vulnerability: [
                    "HIPAA and FERPA provide regulatory frameworks for healthcare and educational data protection",
                    "Professional ethics codes in healthcare and education include privacy protection requirements",
                    "Arts and entertainment have some industry standards for user data protection",
                    "Institutional review processes provide some oversight of data usage in healthcare and education"
                ],
                low_vulnerability: [
                    "Accommodation and food services typically collect less sensitive personal information",
                    "Healthcare and educational sectors have established data governance and security protocols",
                    "Strong professional accountability standards in healthcare and education sectors"
                ]
            }
        };
        
        let currentRisk = '';
        let sectorData = {};
        let totalExperts = 25;
        
        function calculateMedian(responses) {
            const responseOrder = ['not_at_all', 'minimally', 'moderately', 'highly', 'extremely'];
            const counts = responseOrder.map(key => responses[key] || 0);
            const total = counts.reduce((a, b) => a + b, 0);
            
            if (total === 0) return null;
            
            // Create array of all individual responses
            let allResponses = [];
            responseOrder.forEach((response, index) => {
                for (let i = 0; i < counts[index]; i++) {
                    allResponses.push(index);
                }
            });
            
            allResponses.sort((a, b) => a - b);
            
            // Calculate median position
            let medianIndex;
            if (allResponses.length % 2 === 0) {
                medianIndex = Math.floor(allResponses.length / 2) - 1;
            } else {
                medianIndex = Math.floor(allResponses.length / 2);
            }
            
            const medianValue = allResponses[medianIndex];
            return responseOrder[medianValue];
        }
        
        function findMode(responses) {
            let maxCount = 0;
            let mode = null;
            
            Object.keys(responses).forEach(key => {
                if (responses[key] > maxCount) {
                    maxCount = responses[key];
                    mode = key;
                }
            });
            
            return mode;
        }
        
        function getRiskFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('risk') || '1.1';
        }
        
        function loadRiskData(riskId) {
            currentRisk = riskId;
            
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            
            if (!sectorDataStore[riskId]) {
                document.getElementById('errorMessage').style.display = 'block';
                return;
            }
            
            const riskData = sectorDataStore[riskId];
            sectorData = riskData.data;
            totalExperts = riskData.totalExperts;
            
            document.getElementById('mainContent').style.display = 'block';
            updateVisualization();
        }
        
        function updateVisualization() {
            const sectors = Object.keys(sectorData);
            
            sectors.forEach((sector, index) => {
                const row = document.querySelector(`tr[data-sector="${sector}"]`);
                if (!row) return;
                
                // Add alternating row colors
                const dataRows = document.querySelectorAll('tr[data-sector]');
                const sectorIndex = Array.from(dataRows).indexOf(row);
                const isEven = sectorIndex % 2 === 0;
                const backgroundColor = isEven ? '#f0f0f0' : 'white';
                
                // Apply background to all cells in the row
                const cells = row.querySelectorAll('td');
                cells.forEach(cell => {
                    cell.style.backgroundColor = backgroundColor;
                });
                
                const responses = sectorData[sector];
                const total = Object.values(responses).reduce((a, b) => a + b, 0);
                const median = calculateMedian(responses);
                const mode = findMode(responses);
                
                // Calculate the maximum percentage for this row to determine row height
                const percentages = Object.values(responses).map(count => 
                    total > 0 ? (count / total * 100) : 0
                );
                const maxPercentage = Math.max(...percentages);
                const maxBarHeight = Math.max(maxPercentage * 1.2, 3);
                
                // Set dynamic row height based on max bar height with constraints
                const minRowHeight = 60;
                const maxRowHeight = 120;
                const rowHeight = Math.min(Math.max(maxBarHeight + 35, minRowHeight), maxRowHeight);
                
                Object.keys(responses).forEach(responseType => {
                    const cell = row.querySelector(`.response-cell[data-response="${responseType}"]`);
                    if (!cell) return;
                    
                    const count = responses[responseType];
                    const percentage = total > 0 ? (count / total * 100) : 0;
                    
                    // Clear the cell
                    cell.innerHTML = '';
                    
                    // Create bar wrapper with dynamic height
                    const barWrapper = document.createElement('div');
                    barWrapper.className = 'bar-wrapper';
                    barWrapper.style.height = rowHeight + 'px';
                    
                    // Create the vertical bar
                    const bar = document.createElement('div');
                    bar.className = 'distribution-bar';
                    const barHeight = Math.max(percentage * 1.2, 3);
                    bar.style.height = barHeight + 'px';
                    
                    // Set color based on vulnerability level
                    const vulnerabilityColors = {
                        'not_at_all': '#2c7bb6',    // Blue - least vulnerable
                        'minimally': '#abd9e9',     // Light blue
                        'moderately': '#ffffbf',    // Yellow
                        'highly': '#fdae61',        // Orange
                        'extremely': '#d7191c'      // Red - most vulnerable
                    };
                    bar.style.backgroundColor = vulnerabilityColors[responseType] || '#4285f4';
                    
                    // Add median indicator
                    if (responseType === median) {
                        const medianArrow = document.createElement('div');
                        medianArrow.className = 'median-indicator';
                        medianArrow.textContent = '‚ñº';
                        bar.appendChild(medianArrow);
                    }
                    
                    // Create label with percentage and participant count
                    const label = document.createElement('div');
                    label.className = 'bar-label';
                    label.textContent = `${Math.round(percentage)}% (${count})`;
                    
                    barWrapper.appendChild(bar);
                    barWrapper.appendChild(label);
                    cell.appendChild(barWrapper);
                });
            });
        }
        
        // Initialize
        window.addEventListener('load', function() {
            const riskId = getRiskFromURL();
            loadRiskData(riskId);
        });
        
        window.addEventListener('popstate', function() {
            const riskId = getRiskFromURL();
            loadRiskData(riskId);
        });
        
        function addRiskData(riskId, data, expertCount = 25) {
            sectorDataStore[riskId] = {
                data: data,
                totalExperts: expertCount
            };
        }
        
        // Dropdown functionality
        function toggleDropdown() {
            const content = document.getElementById('dropdownContent');
            const arrow = document.getElementById('dropdownArrow');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                arrow.classList.remove('expanded');
            } else {
                content.classList.add('show');
                arrow.classList.add('expanded');
                updateJustificationContent();
            }
        }
        
        function updateJustificationContent() {
            const contentDiv = document.getElementById('justificationContent');
            const riskJustifications = qualitativeJustifications[currentRisk];
            
            if (!riskJustifications) {
                contentDiv.innerHTML = '<p style="color: #666; font-style: italic;">No qualitative justifications available for this risk scenario.</p>';
                return;
            }
            
            let html = '';
            
            if (riskJustifications.high_vulnerability && riskJustifications.high_vulnerability.length > 0) {
                html += `
                    <div class="justification-section">
                        <div class="justification-title">üî¥ High/Extreme Vulnerability Arguments:</div>
                        <ul class="justification-list">
                            ${riskJustifications.high_vulnerability.map(point => `<li>${point}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            if (riskJustifications.moderate_vulnerability && riskJustifications.moderate_vulnerability.length > 0) {
                html += `
                    <div class="justification-section">
                        <div class="justification-title">üü° Moderate Vulnerability Arguments:</div>
                        <ul class="justification-list">
                            ${riskJustifications.moderate_vulnerability.map(point => `<li>${point}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            if (riskJustifications.low_vulnerability && riskJustifications.low_vulnerability.length > 0) {
                html += `
                    <div class="justification-section">
                        <div class="justification-title">üü¢ Low/Minimal Vulnerability Arguments:</div>
                        <ul class="justification-list">
                            ${riskJustifications.low_vulnerability.map(point => `<li>${point}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            contentDiv.innerHTML = html || '<p style="color: #666; font-style: italic;">No qualitative justifications available for this risk scenario.</p>';
        }
        
    </script>
</body>
</html>